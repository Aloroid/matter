<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<title data-react-helmet="true">Reconciliation | matter</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://eryn.io/matter/docs/BestPractices/Reconciliation"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Reconciliation | matter"><meta data-react-helmet="true" name="description" content="The Data Model"><meta data-react-helmet="true" property="og:description" content="The Data Model"><link data-react-helmet="true" rel="canonical" href="https://eryn.io/matter/docs/BestPractices/Reconciliation"><link data-react-helmet="true" rel="alternate" href="https://eryn.io/matter/docs/BestPractices/Reconciliation" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://eryn.io/matter/docs/BestPractices/Reconciliation" hreflang="x-default"><link rel="stylesheet" href="/matter/assets/css/styles.e62b45be.css">
<link rel="preload" href="/matter/assets/js/runtime~main.eab3b302.js" as="script">
<link rel="preload" href="/matter/assets/js/main.c31060bc.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/matter/"><div class="navbar__logo"><img src="/matter/logo.svg" alt="Matter" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/matter/logo.svg" alt="Matter" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title"></b></a><a class="navbar__item navbar__link navbar__link--active" href="/matter/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/matter/api/">API</a><a class="navbar__item navbar__link" href="/matter/changelog">Changelog</a></div><div class="navbar__items navbar__items--right"><a href="https://discord.gg/aQwDAYhqtJ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Roblox Open Source Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://patreon.com/erynlynn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Support on Patreon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/evaera/matter" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Press S to Search..." aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/matter/docs/intro">Matter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/matter/docs/Installation">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/matter/docs/GettingStarted">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/matter/docs/WhyECS">Why ECS</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Best Practices</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/matter/docs/BestPractices/Reconciliation">Reconciliation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/matter/docs/BestPractices/CollectionService">Using CollectionService tags</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Reconciliation</h1></header><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-data-model">The Data Model<a aria-hidden="true" class="hash-link" href="#the-data-model" title="Direct link to heading">â€‹</a></h2><p>In Roblox, the Data Model is the tree of instances which embodies all the things in your game. In Lua, the <code>game</code> global is assigned to the root of this tree, whose class is <code>DataModel</code>. The Data Model is also sometimes called the DOM (Document Object Model), a term borrowed from the Web world.</p><p>When making a game on Roblox, whether a conscious decision or not, the source of truth for game state lives in either in some Lua data structure (e.g., a table), or in the Data Model itself.</p><p>As an example, the Humanoid object has a <code>Health</code> field. Most games on Roblox use the Humanoid&#x27;s <code>Health</code> field as the source of truth for players. Thus, the source of truth for player health lives in the Data Model.</p><p>On the other hand, imagine in your game players can earn points by completing objectives. You create a table which maps players to the number of points they have (e.g., <code>{[Player]: number}</code>). To display the points to the player, you update some text in the game every time the points change. This is an example of the source of truth living in your own code: the <code>points</code> map is the source of truth, and you update the DataModel to reflect this.</p><p>Many games use a mix of these two ideas for different pieces of state. While this <em>can</em> work, it can lead to problems down the line. Largely, these problems are caused by the instances and properties available in the DataModel being unable to adequately represent complex game state in a convenient way. Developers are forced to contort their game state around what&#x27;s available in the DataModel, which makes code difficult to reason about. <a href="https://developer.roblox.com/en-us/articles/instance-attributes" target="_blank" rel="noopener noreferrer">Attributes</a> are an attempt to help solve this problem, but ultimately fall short due to design limitations. You cannot create an attribute with a complex data structure, only primitive values are allowed. And, attributes must be placed on existing instance types, which hamstrings the developer&#x27;s ability to have control over the state of their own game.</p><p>Code becomes simpler to reason about if we instead treat Instances and the Data Model as a sort of <em>intermediate representation</em> of our game&#x27;s state, which is only derived from our true game state: some data structure (e.g., tables) that we keep in Lua.</p><p>This is what the ECS world is: it&#x27;s a place where you can structure your game state however you want, optimized for fast batch operations. There are other approaches to storing game state (e.g. object-oriented classes and encapsulation), but this is an ECS library, so that&#x27;s what we&#x27;ll focus on.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="reconciliation-1">Reconciliation<a aria-hidden="true" class="hash-link" href="#reconciliation-1" title="Direct link to heading">â€‹</a></h2><p>Reconciliation, in this context, means taking state from one form and turning it into another. In our case, we want to reconcile our Lua state into Instances in the Data Model, so that users can see and interact with it. A key idea and benefit of reconciliation is that it&#x27;s possible to reconcile the same state in multiple different ways. If we have enemies in our world at certain positions, we can reconcile them into the world with character models, but also onto a minimap with red blips. It&#x27;s the same state being converted into two different ways to view the data.</p><p>When writing code in an ECS like Matter, it&#x27;s ideal for all of our gameplay code to operate on the ECS world alone. In the Matter example game, for example, there are ships that fly to certain points in space. For example, instead of updating the ships in the Data Model directly, we store the current goal position in the Ship component. The Ship component knows nothing about the Data Model. It has no reference to the physical ship Instance in the Data Model, it only contains the state about the ship.</p><p>We can create another component (in the <a href="https://github.com/evaera/matter/tree/main/example" target="_blank" rel="noopener noreferrer">Matter example game</a>, we call it <code>Model</code>) that holds a reference to the ship Instance.</p><p>We can loop over all Ships that don&#x27;t also have a Model, and create one for it.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">ships.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for id, ship in world:query(Ship):without(Model) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local model = prefabs.Ship:Clone() -- assuming prefabs is a place where you store pre-made models</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    model.Parent = workspace</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    world:insert(id, Model({</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        instance = model</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, whenever there&#x27;s an entity with Ship without Model, we create the model and insert the Model component. We can then loop over all Ships that have Models, and update the position of the Model.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">ships.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for id, ship, model in world:query(Ship, Model) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    model.instance.BodyPosition.Position = ship.goalPosition</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Keep in mind, both of these loops are performed every frame - that&#x27;s what a system does. This means that in order to create a Ship from some other system, we need only spawn an entity with <code>Ship</code> - this system we just wrote takes care of creating and further reconciling the state of the Ship into the Data Model.</p><p>We have a problem now, though: whenever an entity with both Ship and Model is despawned, the physical ship Instance in the Data Model will stick around. Since the Model component is generic and could be reused with any other component (it&#x27;s not specific to just Ship), we can create another system that handles this case for anything that uses Model.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">removeModels.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for _id, modelRecord in world:queryChanged(Model) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if modelRecord.new == nil then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        if modelRecord.old and modelRecord.old.instance then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            modelRecord.old.instance:Destroy()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here, we use <a href="/matter/api/World#queryChanged"><code>queryChanged</code></a> to loop over Model components that have changed in the last frame. <code>queryChanged</code> gives us a <a href="/matter/api/World#ChangeRecord"><code>ChangeRecord</code></a> type, which is a table with <code>old</code> and <code>new</code> properties. If there was an <code>old</code> instance, but no <code>new</code> instance, we know that the Model component has been removed. This can happen when the Model component is removed but the entity still exists (e.g., <code>world:remove(entityId, Model)</code> and also when the entire entity is despawned (e.g., <code>world:despawn(entityId)</code>). We then call <code>Instance:Destroy()</code> on the Instance.</p><p>Now that we&#x27;ve written this code once for our game, it will operate on any entity that has a Model component. This means that calling <code>world:despawn</code> on an entity with Ship and Model will result in the physical Instance also being removed.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="reverse-bindings">Reverse bindings<a aria-hidden="true" class="hash-link" href="#reverse-bindings" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="events">Events<a aria-hidden="true" class="hash-link" href="#events" title="Direct link to heading">â€‹</a></h3><p>While we generally want our state to flow in one direction (Lua into the DataModel), we must also be able to interact with the things we&#x27;ve created. Roblox Instances have events that fire, (e.g., Touched) which are still things we need to use.</p><p>As an example, let&#x27;s say we wanted the Ship to despawn if it was touched by anything. We can use Matter&#x27;s <a href="/matter/api/Matter#useEvent"><code>useEvent</code></a> utility to collect events that fire in a frame and loop over them.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">ships.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for id, model in world:query(Model, Ship) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    for _ in Matter.useEvent(model.Instance, &quot;Touched&quot;) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        world:despawn(id)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="removal">Removal<a aria-hidden="true" class="hash-link" href="#removal" title="Direct link to heading">â€‹</a></h3><p>Sometimes, instances can be removed from the Data Model or destroyed without us doing it. A common cause of this is because parts that are affected by physics fall below the world or get flung to infinity. This can result in those instances being removed without us doing so.</p><p>To account for this, we can simply loop over every Model and check if it&#x27;s still in the world. If not, we can either remove the Model component or despawn the entire entity (whichever makes more sense for your game).</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">removeModels.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">for id, model in world:query(Model) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if model.instance:IsDescendantOf(game) == false then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        world:remove(id, Model)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As a side effect, the above code makes it so manually deleting an Instance in a play test in Studio will cause it to be instantly recreated in the same place. This may or may not be the behavior that you want, but it sure is interesting!</p><p>It should be noted that this method can cause an infinite loop of a Model being created and destroyed if the last Transform was at an invalid position. This can be solved by either just despawning the entire entity instead, or taking care to reset Transform to a known-safe position when removing models.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="two-way-bindings">Two-way bindings<a aria-hidden="true" class="hash-link" href="#two-way-bindings" title="Direct link to heading">â€‹</a></h2><p>Imagine we had a component that held the position and rotation of something. This is often called <code>Transform</code>. Our <code>Transform</code> component would hold a CFrame value.</p><p>There are two potential ways we could want to use this component:</p><ul><li>We want to update our Transform component and have the physical Instance be moved to that place.</li><li>We want the Transform component to be updated based on where the Instance is in the world, because physics can move it around.</li></ul><p>We can make a system that handles both of these cases for us.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">updateTransforms.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Handle Transform added/changed to existing entity with Model</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for _id, transformRecord, model in world:queryChanged(Transform, Model) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Take care to ignore the changed event if it was us that triggered it</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if transformRecord.new and not transformRecord.new.doNotReconcile then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        model.instance:SetPrimaryPartCFrame(transformRecord.new.cframe)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Handle Model added/changed on existing entity with Transform</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for _id, modelRecord, transform in world:queryChanged(Model, Transform) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if modelRecord.new then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        modelRecord.new.model:SetPrimaryPartCFrame(transform.cframe)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Update Transform on unanchored Models</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for id, model, transform in world:query(Model, Transform) do</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if model.instance.PrimaryPart.Anchored then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        continue</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local existingCFrame = transform.cframe</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    local currentCFrame = model.instance.PrimaryPart.CFrame</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Only insert if actual position is different from the Transform component</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if currentCFrame ~= existingCFrame then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        world:insert(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            id,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Components.Transform({</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                cframe = currentCFrame,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                doNotReconcile = true,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            })</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The above system handles the following cases:</p><ul><li>When the Transform component is inserted on an entity that also has Model, move the Model to that position.*</li><li>When the Model component is inserted on an entity that also has Transform, move the Model to that position.</li><li>When an unanchored Model moves, update the Transform component to match its new position.</li></ul><p>*<!-- --> We only update the Transform component if it wasn&#x27;t us that caused it to move.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="benefits-of-reconciliation">Benefits of reconciliation<a aria-hidden="true" class="hash-link" href="#benefits-of-reconciliation" title="Direct link to heading">â€‹</a></h2><p>When we structure our game code in this manner, it allows us to do some cool things. For example:</p><ul><li>Creating a new entity (like a ship) from other systems is as simple as just spawning an entity with a Ship component. We don&#x27;t have to worry about creating the model for it, because the ship system will look for Ships without Models and make them for us.</li><li>Likewise, despawning an entity does what we expect. We can just despawn it from any system, and our generic model system will handle cleaning up the model.</li><li>We don&#x27;t need to access the Model component of a ship to know where it is in the world, we only need to read the Transform component, even if it&#x27;s affected by physics. Likewise, to move a ship, we only need to write to (insert) the Transform component.</li><li>We could copy the entire ECS world at a given point in time, since it&#x27;s just plain-old data<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>, and then restore it later. Our systems won&#x27;t know the difference: models that didn&#x27;t exist and now do will be created, models that exist now but didn&#x27;t before will be destroyed, and models that still exist will snap into the correct position.</li><li>We can reconcile the same state multiple times into the world, like marking ships on a minimap.</li></ul><div class="footnotes"><hr><ol><li id="fn-1">If saving the data, we would need to take special care to serialize things like CFrame values and Vector3 into JSON-compatible data, but that&#x27;s beyond the scope of this article<a href="#fnref-1" class="footnote-backref">â†©</a></li></ol></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/evaera/matter/edit/main/docs/BestPractices/Reconciliation.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/matter/docs/WhyECS"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Why ECS</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/matter/docs/BestPractices/CollectionService"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using CollectionService tags<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-data-model" class="table-of-contents__link toc-highlight">The Data Model</a></li><li><a href="#reconciliation-1" class="table-of-contents__link toc-highlight">Reconciliation</a></li><li><a href="#reverse-bindings" class="table-of-contents__link toc-highlight">Reverse bindings</a><ul><li><a href="#events" class="table-of-contents__link toc-highlight">Events</a></li><li><a href="#removal" class="table-of-contents__link toc-highlight">Removal</a></li></ul></li><li><a href="#two-way-bindings" class="table-of-contents__link toc-highlight">Two-way bindings</a></li><li><a href="#benefits-of-reconciliation" class="table-of-contents__link toc-highlight">Benefits of reconciliation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 evaera. Built with Moonwave and Docusaurus.</div></div></div></footer></div>
<script src="/matter/assets/js/runtime~main.eab3b302.js"></script>
<script src="/matter/assets/js/main.c31060bc.js"></script>
</body>
</html>